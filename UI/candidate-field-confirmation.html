<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Candidate - Field Confirmation</title>
  <link rel="stylesheet" href="styles.css">
  <link rel="stylesheet" href="glass-style.css">
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    crossorigin=""
  >
</head>
<body class="glass-theme has-topbar">
  <div class="bg-orb orb-c" aria-hidden="true"></div>
  <header class="topbar">
    <div class="container">
      <div class="auth-brand"><span class="auth-brand-strong">job</span><span class="auth-brand-thin">arium</span><span class="auth-brand-tm">TM</span></div>
      <nav class="nav-links small">
        <a class="btn secondary" href="candidate-profile-completeness.html">Account</a>
        <button class="btn secondary" onclick="UIFlow.resetFlow()">Log out</button>
      </nav>
    </div>
  </header>
  <main class="layout">
    <section class="container">
      <article class="card auth-glass-card field-confirm-card">
        <h1>CAND-004: High Impact Field Confirmation</h1>
        <p class="muted">Complete required fields to become matchable with high confidence.</p>

        <div class="match-card">
          <h3>Preferred positions (up to 5)</h3>
          <p class="small muted">Select from suggestions or type a custom role and add it.</p>
          <div class="range-row">
            <input id="roleInput" class="input" placeholder="Type a role and press Add">
            <button class="btn secondary" id="addRoleBtn" type="button">Add role</button>
          </div>
          <div class="chip-wrap" id="roleChips"></div>
          <div class="small muted" id="roleCount"></div>
          <div class="suggestion-grid" id="roleSuggestions"></div>
        </div>

        <div class="match-card">
          <h3>Location preference</h3>
          <p class="small muted">Use one unified model across onsite, hybrid, remote, regional, and worldwide.</p>
          <div class="grid-2">
            <div>
              <label for="workMode">Work mode</label>
              <select id="workMode">
                <option value="onsite">On-site</option>
                <option value="hybrid">Hybrid</option>
                <option value="remote">Remote</option>
              </select>
            </div>
            <div>
              <label for="locationScope">Location scope</label>
              <select id="locationScope">
                <option value="radius">Radius from anchor location</option>
                <option value="region">Region or country selection</option>
                <option value="worldwide">Worldwide</option>
              </select>
            </div>
          </div>

          <div id="radiusSection" class="map-box">
            <label for="anchorLocation">Anchor location</label>
            <input id="anchorLocation" class="input" placeholder="Chicago, IL">
            <div id="radiusMap" class="map-stage"></div>
            <label for="radiusKm">Radius (km): <span id="radiusLabel">25</span></label>
            <input id="radiusKm" type="range" min="5" max="300" step="5" value="25">
          </div>

          <div id="regionSection" class="map-box">
            <label>Allowed regions or countries</label>
            <div class="suggestion-grid" id="regionChecklist"></div>
          </div>
        </div>

        <div class="match-card">
          <h3>Compensation preference</h3>
          <div class="grid-2">
            <div>
              <label for="currency">Currency</label>
              <select id="currency">
                <option value="USD">USD</option>
                <option value="EUR">EUR</option>
                <option value="GBP">GBP</option>
              </select>
            </div>
            <div>
              <label for="period">Period</label>
              <select id="period">
                <option value="year">Per year</option>
                <option value="month">Per month</option>
                <option value="hour">Per hour</option>
              </select>
            </div>
          </div>

          <div class="range-row">
            <div>
              <label for="minComp">Minimum desired</label>
              <div class="number-input-wrap">
                <input id="minComp" class="input" type="number" min="0" step="1000">
                <div class="number-stepper" aria-hidden="true">
                  <button class="number-step-btn" type="button" data-step-target="minComp" data-step-dir="up" aria-label="Increase minimum desired"></button>
                  <button class="number-step-btn" type="button" data-step-target="minComp" data-step-dir="down" aria-label="Decrease minimum desired"></button>
                </div>
              </div>
            </div>
            <div>
              <label for="maxComp">Maximum desired</label>
              <div class="number-input-wrap">
                <input id="maxComp" class="input" type="number" min="0" step="1000">
                <div class="number-stepper" aria-hidden="true">
                  <button class="number-step-btn" type="button" data-step-target="maxComp" data-step-dir="up" aria-label="Increase maximum desired"></button>
                  <button class="number-step-btn" type="button" data-step-target="maxComp" data-step-dir="down" aria-label="Decrease maximum desired"></button>
                </div>
              </div>
            </div>
          </div>

          <div class="small muted field-comp-summary" id="compSummary"></div>
          <div class="actions">
            <button class="btn secondary" id="benchmarkBtn" type="button">Apply market median hint</button>
          </div>
        </div>

        <div class="match-card">
          <h3>Earliest start (required)</h3>
          <div class="grid-2">
            <div>
              <label for="earliestStart">When can you start?</label>
              <select id="earliestStart">
                <option value="">Select...</option>
                <option value="immediate">Immediate</option>
                <option value="1_week">Within 1 week</option>
                <option value="2_weeks">Within 2 weeks</option>
                <option value="1_month">Within 1 month</option>
                <option value="custom_date">Choose date</option>
              </select>
            </div>
            <div id="customStartWrap">
              <label for="customStartDate">Custom start date</label>
              <input id="customStartDate" class="input glass-date-picker" type="date">
            </div>
          </div>
          <p class="small muted">
            Schedule preference (full-time, part-time, shift preference) should be captured in profile enrichment,
            not as a required gate at this step.
          </p>
        </div>

        <div class="actions field-confirm-footer-actions">
          <a class="btn secondary field-confirm-back" href="candidate-cv-upload.html">Back</a>
          <button class="btn success field-confirm-save" id="saveBtn" type="button">Save and continue</button>
          <a class="btn field-confirm-next" href="candidate-profile-completeness.html">Continue</a>
        </div>
      </article>
      <div class="field-confirm-status-slot">
        <div class="status-box hidden" data-status role="status" aria-live="polite"></div>
      </div>
    </section>
  </main>

  <div id="toast" class="toast" role="status" aria-live="polite"></div>
  <script src="app.js"></script>
  <script src="glass-date-picker.js"></script>
  <script src="glass-select.js"></script>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
  <script>
    UIFlow.guard("candidate");
    const ROLE_SUGGESTIONS = [
      "Warehouse Operations Lead",
      "Maintenance Supervisor",
      "Inventory Control Manager",
      "Facilities Technician",
      "Logistics Coordinator",
      "Operations Manager",
      "Quality Assurance Lead",
      "Production Supervisor"
    ];
    const REGION_OPTIONS = ["USA", "Canada", "UK", "EU", "Worldwide"];

    const s0 = UIFlow.readState();
    const onboarding = s0.candidate.onboarding;
    let selectedRoles = Array.isArray(onboarding.preferredRoles) && onboarding.preferredRoles.length
      ? [...onboarding.preferredRoles]
      : (onboarding.rolePreference ? onboarding.rolePreference.split(",").map((v) => v.trim()).filter(Boolean) : []);
    selectedRoles = selectedRoles.slice(0, 5);

    let locationPref = onboarding.locationPref || {
      workMode: "onsite",
      scope: "radius",
      anchor: "",
      radiusKm: 25,
      regions: []
    };
    let compensation = onboarding.compensation || { min: 70000, max: 85000, currency: "USD", period: "year" };
    let earliestStart = onboarding.earliestStart || "2_weeks";

    const roleInput = document.getElementById("roleInput");
    const roleChips = document.getElementById("roleChips");
    const roleCount = document.getElementById("roleCount");
    const roleSuggestions = document.getElementById("roleSuggestions");
    const workMode = document.getElementById("workMode");
    const locationScope = document.getElementById("locationScope");
    const radiusSection = document.getElementById("radiusSection");
    const regionSection = document.getElementById("regionSection");
    const anchorLocation = document.getElementById("anchorLocation");
    const radiusKm = document.getElementById("radiusKm");
    const radiusLabel = document.getElementById("radiusLabel");
    const radiusMap = document.getElementById("radiusMap");
    const regionChecklist = document.getElementById("regionChecklist");
    const currency = document.getElementById("currency");
    const period = document.getElementById("period");
    const minComp = document.getElementById("minComp");
    const maxComp = document.getElementById("maxComp");
    const compSummary = document.getElementById("compSummary");
    const earliestStartSelect = document.getElementById("earliestStart");
    const customStartWrap = document.getElementById("customStartWrap");
    const customStartDate = document.getElementById("customStartDate");
    let map = null;
    let mapMarker = null;
    let mapCircle = null;

    function updateMapRadius() {
      if (!mapCircle) return;
      mapCircle.setRadius(Math.max(1, Number(locationPref.radiusKm || 25)) * 1000);
      if (mapMarker) {
        const group = L.featureGroup([mapMarker, mapCircle]);
        map.fitBounds(group.getBounds().pad(0.2), { animate: false });
      }
    }

    async function geocodeAnchor(query) {
      const q = query.trim();
      if (!q) return null;
      const url = `https://nominatim.openstreetmap.org/search?format=json&limit=1&q=${encodeURIComponent(q)}`;
      try {
        const resp = await fetch(url, { headers: { Accept: "application/json" } });
        if (!resp.ok) return null;
        const data = await resp.json();
        const first = Array.isArray(data) ? data[0] : null;
        if (!first) return null;
        return {
          lat: Number(first.lat),
          lng: Number(first.lon),
          displayName: first.display_name || q
        };
      } catch {
        return null;
      }
    }

    async function syncMapFromAnchor() {
      if (!map || locationPref.scope !== "radius") return;
      const resolved = await geocodeAnchor(anchorLocation.value || locationPref.anchor || "");
      if (!resolved) return;

      const center = [resolved.lat, resolved.lng];
      if (!mapMarker) {
        mapMarker = L.marker(center).addTo(map);
      } else {
        mapMarker.setLatLng(center);
      }
      mapMarker.bindPopup(resolved.displayName);

      if (!mapCircle) {
        mapCircle = L.circle(center, {
          radius: Math.max(1, Number(locationPref.radiusKm || 25)) * 1000,
          color: "#7aa6ff",
          weight: 1,
          fillColor: "#6f8cff",
          fillOpacity: 0.18
        }).addTo(map);
      } else {
        mapCircle.setLatLng(center);
      }

      const group = L.featureGroup([mapMarker, mapCircle]);
      map.fitBounds(group.getBounds().pad(0.2), { animate: true });
    }

    function initRadiusMap() {
      if (!radiusMap || !window.L) return;
      map = L.map(radiusMap, {
        zoomControl: true,
        scrollWheelZoom: false
      }).setView([41.8781, -87.6298], 10);

      L.tileLayer("https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png", {
        attribution: "&copy; OpenStreetMap contributors",
        maxZoom: 19
      }).addTo(map);

      // Initial marker/circle for default radius map mode.
      mapMarker = L.marker([41.8781, -87.6298]).addTo(map);
      mapCircle = L.circle([41.8781, -87.6298], {
        radius: Math.max(1, Number(locationPref.radiusKm || 25)) * 1000,
        color: "#7aa6ff",
        weight: 1,
        fillColor: "#6f8cff",
        fillOpacity: 0.18
      }).addTo(map);

      if (locationPref.anchor) {
        syncMapFromAnchor();
      } else {
        mapMarker.bindPopup("Chicago, IL");
      }
    }

    function formatMoney(v) {
      return new Intl.NumberFormat("en-US", { maximumFractionDigits: 0 }).format(Number(v) || 0);
    }

    function renderRoleSuggestions() {
      roleSuggestions.innerHTML = ROLE_SUGGESTIONS.map((role) => `
        <label class="checkbox-row">
          <input type="checkbox" value="${role}" ${selectedRoles.includes(role) ? "checked" : ""} ${selectedRoles.length >= 5 && !selectedRoles.includes(role) ? "disabled" : ""}>
          <span>${role}</span>
        </label>
      `).join("");
      roleSuggestions.querySelectorAll("input[type='checkbox']").forEach((el) => {
        el.addEventListener("change", () => {
          const value = el.value;
          if (el.checked) {
            addRole(value);
          } else {
            selectedRoles = selectedRoles.filter((r) => r !== value);
            renderRoles();
          }
        });
      });
    }

    function renderRoles() {
      roleChips.innerHTML = selectedRoles.map((role) => `
        <span class="chip">${role}<button type="button" data-role="${role}" aria-label="Remove ${role}">x</button></span>
      `).join("");
      roleCount.textContent = `${selectedRoles.length}/5 selected`;
      roleChips.querySelectorAll("button[data-role]").forEach((btn) => {
        btn.addEventListener("click", () => {
          const role = btn.getAttribute("data-role");
          selectedRoles = selectedRoles.filter((r) => r !== role);
          renderRoles();
        });
      });
      renderRoleSuggestions();
    }

    function addRole(role) {
      const normalized = role.trim();
      if (!normalized) return;
      if (selectedRoles.includes(normalized)) {
        UIFlow.showStatus("error-recoverable", "This role is already selected.");
        return;
      }
      if (selectedRoles.length >= 5) {
        UIFlow.showStatus("error-recoverable", "You can select up to 5 roles.");
        return;
      }
      selectedRoles.push(normalized);
      roleInput.value = "";
      renderRoles();
      UIFlow.showStatus("success", "Role added.");
    }

    function renderRegionChecklist() {
      const regions = Array.isArray(locationPref.regions) ? locationPref.regions : [];
      const worldwideSelected = regions.includes("Worldwide");
      regionChecklist.innerHTML = REGION_OPTIONS.map((region) => `
        <label class="checkbox-row">
          <input type="checkbox" value="${region}" ${regions.includes(region) ? "checked" : ""} ${worldwideSelected && region !== "Worldwide" ? "disabled" : ""}>
          <span>${region}</span>
        </label>
      `).join("");
      regionChecklist.querySelectorAll("input[type='checkbox']").forEach((el) => {
        el.addEventListener("change", () => {
          const value = el.value;
          let next = new Set(locationPref.regions || []);
          if (el.checked) {
            if (value === "Worldwide") {
              next = new Set(["Worldwide"]);
            } else {
              next.delete("Worldwide");
              next.add(value);
            }
          } else {
            next.delete(value);
          }
          locationPref.regions = Array.from(next);
          renderRegionChecklist();
        });
      });
    }

    function renderLocationSections() {
      radiusSection.style.display = locationPref.scope === "radius" ? "block" : "none";
      regionSection.style.display = locationPref.scope === "region" ? "block" : "none";
      if (locationPref.scope === "radius" && map) {
        setTimeout(() => map.invalidateSize(), 0);
      }
      if (locationPref.scope === "worldwide") {
        UIFlow.showStatus("success", "Worldwide scope selected.");
      }
    }

    function syncCompFromInputs() {
      compensation.min = Number(minComp.value || 0);
      compensation.max = Number(maxComp.value || 0);
      if (compensation.min > compensation.max) {
        const t = compensation.min;
        compensation.min = compensation.max;
        compensation.max = t;
      }
      minComp.value = compensation.min;
      maxComp.value = compensation.max;
      const median = Math.round((compensation.min + compensation.max) / 2);
      compSummary.textContent = `Median target: ${formatMoney(median)} ${compensation.currency}/${compensation.period}`;
    }

    roleInput.addEventListener("keydown", (e) => {
      if (e.key === "Enter") {
        e.preventDefault();
        addRole(roleInput.value);
      } else if (e.key === "Backspace" && !roleInput.value && selectedRoles.length) {
        selectedRoles.pop();
        renderRoles();
      }
    });
    document.getElementById("addRoleBtn").addEventListener("click", () => addRole(roleInput.value));

    workMode.value = locationPref.workMode || "onsite";
    locationScope.value = locationPref.scope || "radius";
    anchorLocation.value = locationPref.anchor || "";
    radiusKm.value = locationPref.radiusKm || 25;
    radiusLabel.textContent = radiusKm.value;
    workMode.addEventListener("change", () => { locationPref.workMode = workMode.value; });
    locationScope.addEventListener("change", () => {
      locationPref.scope = locationScope.value;
      renderLocationSections();
    });
    anchorLocation.addEventListener("input", () => { locationPref.anchor = anchorLocation.value.trim(); });
    anchorLocation.addEventListener("blur", syncMapFromAnchor);
    anchorLocation.addEventListener("keydown", (e) => {
      if (e.key === "Enter") {
        e.preventDefault();
        syncMapFromAnchor();
      }
    });
    radiusKm.addEventListener("input", () => {
      locationPref.radiusKm = Number(radiusKm.value);
      radiusLabel.textContent = radiusKm.value;
      updateMapRadius();
    });

    currency.value = compensation.currency || "USD";
    period.value = compensation.period || "year";
    minComp.value = compensation.min || 70000;
    maxComp.value = compensation.max || 85000;

    [minComp, maxComp].forEach((el) => el.addEventListener("input", syncCompFromInputs));
    document.querySelectorAll(".number-step-btn").forEach((btn) => {
      btn.addEventListener("click", () => {
        const input = document.getElementById(btn.getAttribute("data-step-target"));
        if (!input) return;

        const step = Number(input.step) || 1;
        const min = input.min === "" ? Number.NEGATIVE_INFINITY : Number(input.min);
        const max = input.max === "" ? Number.POSITIVE_INFINITY : Number(input.max);
        const current = Number(input.value || 0);
        const dir = btn.getAttribute("data-step-dir") === "down" ? -1 : 1;
        const next = Math.min(max, Math.max(min, current + dir * step));

        input.value = String(next);
        input.dispatchEvent(new Event("input", { bubbles: true }));
      });
    });
    currency.addEventListener("change", () => { compensation.currency = currency.value; syncCompFromInputs(); });
    period.addEventListener("change", () => { compensation.period = period.value; syncCompFromInputs(); });

    document.getElementById("benchmarkBtn").addEventListener("click", () => {
      const anchorRole = selectedRoles[0] || "default";
      const benchmarkByRole = {
        "Warehouse Operations Lead": [78000, 92000],
        "Maintenance Supervisor": [72000, 86000],
        "Inventory Control Manager": [70000, 84000],
        default: [70000, 85000]
      };
      const band = benchmarkByRole[anchorRole] || benchmarkByRole.default;
      compensation.min = band[0];
      compensation.max = band[1];
      minComp.value = compensation.min;
      maxComp.value = compensation.max;
      syncCompFromInputs();
      UIFlow.showStatus("success", "Market median hint applied.");
    });

    earliestStartSelect.value = earliestStart;
    earliestStartSelect.addEventListener("change", () => {
      earliestStart = earliestStartSelect.value;
      customStartWrap.style.display = earliestStart === "custom_date" ? "block" : "none";
    });
    customStartWrap.style.display = earliestStart === "custom_date" ? "block" : "none";

    document.getElementById("saveBtn").addEventListener("click", () => {
      if (!selectedRoles.length) {
        UIFlow.showStatus("error-recoverable", "Select at least one preferred role.");
        return;
      }
      if (selectedRoles.length > 5) {
        UIFlow.showStatus("error-recoverable", "You can select up to five roles only.");
        return;
      }
      if (locationPref.scope === "radius" && !anchorLocation.value.trim()) {
        UIFlow.showStatus("error-recoverable", "Set an anchor location for radius-based matching.");
        return;
      }
      if (locationPref.scope === "region" && (!locationPref.regions || !locationPref.regions.length)) {
        UIFlow.showStatus("error-recoverable", "Select at least one region/country, or use Worldwide scope.");
        return;
      }
      if (!(compensation.min > 0 && compensation.max > 0 && compensation.min < compensation.max)) {
        UIFlow.showStatus("error-recoverable", "Compensation range must have valid min and max values.");
        return;
      }
      if (!earliestStartSelect.value) {
        UIFlow.showStatus("error-recoverable", "Choose your earliest start window.");
        return;
      }
      if (earliestStartSelect.value === "custom_date" && !customStartDate.value) {
        UIFlow.showStatus("error-recoverable", "Choose a custom start date.");
        return;
      }

      const rolePreference = selectedRoles.join(", ");
      const location = locationPref.scope === "radius"
        ? `${locationPref.workMode} near ${locationPref.anchor} (${locationPref.radiusKm} km)`
        : locationPref.scope === "region"
          ? `${locationPref.workMode} in ${locationPref.regions.join(", ")}`
          : `${locationPref.workMode} worldwide`;
      const payRange = `${compensation.currency} ${formatMoney(compensation.min)} - ${formatMoney(compensation.max)} per ${compensation.period}`;
      const availability = earliestStartSelect.value === "custom_date"
        ? `custom_date:${customStartDate.value}`
        : earliestStartSelect.value;

      const s = UIFlow.readState();
      UIFlow.updateState({
        candidate: {
          ...s.candidate,
          onboarding: {
            ...s.candidate.onboarding,
            requiredCompleted: true,
            preferredRoles: selectedRoles,
            locationPref: {
              workMode: locationPref.workMode,
              scope: locationPref.scope,
              anchor: locationPref.anchor,
              radiusKm: Number(locationPref.radiusKm),
              regions: [...(locationPref.regions || [])]
            },
            compensation: {
              min: Number(compensation.min),
              max: Number(compensation.max),
              currency: compensation.currency,
              period: compensation.period
            },
            earliestStart: availability,
            rolePreference,
            location,
            payRange,
            availability,
            profileCompleteness: Math.max(68, s.candidate.onboarding.profileCompleteness)
          }
        }
      });
      UIFlow.showStatus("success", "Required profile fields saved.");
      UIFlow.showToast("Profile essentials completed.");
    });

    renderRoles();
    renderRegionChecklist();
    renderLocationSections();
    syncCompFromInputs();
    initRadiusMap();
    UIFlow.showStatus("loading", "Loading parsed profile fields...");
    setTimeout(() => UIFlow.showStatus("success", "Confirm required fields and continue."), 400);
  </script>
</body>
</html>
